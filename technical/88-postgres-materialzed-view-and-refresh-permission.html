<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>PostgreSQL: Materialized View and Refresh Permission | Minh Nhật’s blog</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="PostgreSQL: Materialized View and Refresh Permission" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="1. Materialized View (MatView) là gì? 2. Refresh MatView? 3. Vấn đề permission khi refresh 4. References" />
<meta property="og:description" content="1. Materialized View (MatView) là gì? 2. Refresh MatView? 3. Vấn đề permission khi refresh 4. References" />
<link rel="canonical" href="/technical/88-postgres-materialzed-view-and-refresh-permission" />
<meta property="og:url" content="/technical/88-postgres-materialzed-view-and-refresh-permission" />
<meta property="og:site_name" content="Minh Nhật’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-02-05T00:02:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="PostgreSQL: Materialized View and Refresh Permission" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-02-05T00:02:00+00:00","datePublished":"2025-02-05T00:02:00+00:00","description":"1. Materialized View (MatView) là gì? 2. Refresh MatView? 3. Vấn đề permission khi refresh 4. References","headline":"PostgreSQL: Materialized View and Refresh Permission","mainEntityOfPage":{"@type":"WebPage","@id":"/technical/88-postgres-materialzed-view-and-refresh-permission"},"url":"/technical/88-postgres-materialzed-view-and-refresh-permission"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Minh Nhật&apos;s blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Minh Nhật&#39;s blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <!-- <div class="trigger"><a class="page-link" href="/404.html"></a><a class="page-link" href="/about/">Về tôi</a><a class="page-link" href="/art">art</a><a class="page-link" href="/finance">Finance</a><a class="page-link" href="/"></a><a class="page-link" href="/assets/main.css"></a><a class="page-link" href="/opinion">opinion</a><a class="page-link" href="/philosophy">Philosophy</a><a class="page-link" href="/technical">technical</a><a class="page-link" href="/art">art</a><a class="page-link" href="/art/">art</a><a class="page-link" href="/finance">Finance</a><a class="page-link" href="/finance/">Finance</a><a class="page-link" href="/"></a><a class="page-link" href="/"></a><a class="page-link" href="/page1/"></a><a class="page-link" href="/page2/"></a><a class="page-link" href="/page3/"></a><a class="page-link" href="/page4/"></a><a class="page-link" href="/opinion">opinion</a><a class="page-link" href="/opinion/">opinion</a><a class="page-link" href="/philosophy">Philosophy</a><a class="page-link" href="/philosophy/">Philosophy</a><a class="page-link" href="/technical">technical</a><a class="page-link" href="/technical/">technical</a><a class="page-link" href="/feed.xml"></a></div> -->
        <div class="trigger">
          <a class="page-link" href="/philosophy">Triết học</a>
          <a class="page-link" href="/art">Văn, thơ, nhạc</a>
          <a class="page-link" href="/opinion">Góc nhìn cá nhân</a>
          <a class="page-link" href="/technical">IT</a>
          <a class="page-link" href="/finance">Finance</a>
          <a class="page-link" href="/about">Về tôi</a>
        </div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">88.  PostgreSQL: Materialized View and Refresh Permission</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2025-02-05T00:02:00+00:00" itemprop="datePublished">Feb 5, 2025
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul>
  <li><a href="#1-materialized-view-matview-là-gì">1. Materialized View (MatView) là gì?</a></li>
  <li><a href="#2-refresh-matview">2. Refresh MatView?</a></li>
  <li><a href="#3-vấn-đề-permission-khi-refresh">3. Vấn đề permission khi refresh</a></li>
  <li><a href="#4-references">4. References</a></li>
</ul>

<h3 id="1-materialized-view-matview-là-gì">1. Materialized View (MatView) là gì?</h3>

<p>MatView là 1 bảng ảo được tạo bởi câu SELECT query, và lưu trữ lại kết quả vào hard disk. Khác với View, View không lưu trữ kết quả ở đĩa cứng.</p>

<p>Vì kết quả đã được tính toán sẵn, nên khi có câu lệnh query vào MatView, nó sẽ không tính toán lại. Điều này giúp câu lệnh nhanh hơn.</p>

<p>Tuy nhiên, nó gặp phải 3 khó khăn chính [1]</p>
<ul>
  <li>Làm hệ thống trở nên phức tạp hơn, gia tăng độ phức tạp khi maintenance.</li>
  <li>Dữ liệu trên view không up-to-date. Với Postgres, cần phải refresh định kì và thủ công.</li>
  <li>Postgres chỉ hỗ trợ Full-refresh, tính toán lại toàn bộ view nên quá trình này tiêu tốn nhiều tài nguyên.</li>
</ul>

<h3 id="2-refresh-matview">2. Refresh MatView?</h3>

<p>Giả sử ta có view name: mymatview. Để refresh MatView, ta có thể dùng câu lệnh:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">REFRESH</span> <span class="n">MATERIALIZED</span> <span class="k">VIEW</span> <span class="n">mymatview</span><span class="p">;</span>
</code></pre></div></div>

<p>Tuy nhiên, câu lệnh trên sẽ block mymatview, các concurrent user khác sẽ không thể truy cập khi view đang refresh. Điều này là không thể chấp nhận nếu matview phục vụ real-time user</p>

<p>Để khắc phục điều này, ta có thể thêm keyword CONCURRENTLY</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">REFRESH</span> <span class="n">MATERIALIZED</span> <span class="k">VIEW</span> <span class="n">CONCURRENTLY</span> <span class="n">mymatview</span><span class="p">;</span>
</code></pre></div></div>

<p>Thêm CONCURRENTLY sẽ khiến việc refresh view chậm hơn. Tuy nhiên, các concurrent user khác có thể sử dụng view khi view đang refresh. Muốn sử dụng CONCURRENTLY, buộc phải tạo 1 unique index cho view. Nếu không, sẽ báo lỗi. [4]</p>

<h3 id="3-vấn-đề-permission-khi-refresh">3. Vấn đề permission khi refresh</h3>
<p>Một lưu ý rất quan trọng, theo [4], “To execute this command you must be the owner of the materialized view”. Tức là, để chạy lệnh refresh, user thực thi câu lệnh phải là owner của MatView.</p>

<p>Tuy nhiên, sẽ có trường hợp ta quản lý schema, table và view bằng Flyway. Ta dùng flyway_user để tạo table, matview. Sau khi tạo xong, sẽ lock flyway_user lại. Lúc này, owner của matview là flyway_user nhưng nó đã bị lock. Làm sao để ta thực hiện scheduler refresh?</p>

<p>Giả sử user ta dùng cho webApp là my_user. Nếu sử dụng my_user để refresh, sẽ báo lỗi <code class="language-plaintext highlighter-rouge">ERROR:  must be owner of materialized view test_mv</code></p>

<p>[2] cho ta 1 lựa chọn hợp lý. Ta sử dụng role membership để xử lý chuyện này.</p>

<ul>
  <li>Bước 1: tạo 1 role có tên <code class="language-plaintext highlighter-rouge">owner_mat_view</code>. Cần đảm bảo role mới tạo có quyền đọc tất cả các bảng trong câu lệnh tạo view.</li>
  <li>Bước 2: Đổi owner của view về role owner_mat_view. <code class="language-plaintext highlighter-rouge">ALTER MATERIALIZED VIEW test_mv OWNER TO owner_mat_view;</code></li>
  <li>Bước 3: Gán quyền của role owner_mat_view cho user my_user <code class="language-plaintext highlighter-rouge">GRANT owner_mat_view TO my_user;</code> Lúc này, my_user sẽ kế thừa toàn bộ quyền của owner_mat_view.</li>
  <li>Bước 4: Đổi role sang my_view. <code class="language-plaintext highlighter-rouge">SET ROLE my_user;</code></li>
  <li>Bước 5: Thực hiện refresh với user my_user. <code class="language-plaintext highlighter-rouge">REFRESH MATERIALIZED VIEW test_mv;</code> ==&gt; thành công</li>
</ul>

<h3 id="4-references">4. References</h3>
<ol>
  <li><a href="https://aws.amazon.com/what-is/materialized-view/">What is a Materialized View?</a></li>
  <li><a href="https://blog.rustprooflabs.com/2021/07/postgres-permission-mat-view">Postgres Permissions and Materialized Views</a></li>
  <li><a href="https://www.postgresql.org/docs/current/rules-materializedviews.html">39.3. Materialized Views</a></li>
  <li><a href="https://www.postgresql.org/docs/16/sql-refreshmaterializedview.html">REFRESH MATERIALIZED VIEW</a></li>
</ol>


  </div><a class="u-url" href="/technical/88-postgres-materialzed-view-and-refresh-permission" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Contact</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Minh Nhật&#39;s blog</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"></ul>
</div>

      <div class="footer-col footer-col-3">
        <p></p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
