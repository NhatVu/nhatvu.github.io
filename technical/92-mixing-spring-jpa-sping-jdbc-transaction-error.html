<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Mixing Spring JPA and Spring JDBC error: Row was updated or deleted by another transaction (or unsaved-value mapping was incorrect) | Minh Nhật’s blog</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Mixing Spring JPA and Spring JDBC error: Row was updated or deleted by another transaction (or unsaved-value mapping was incorrect)" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Gần đây, tôi gặp 1 trường hợp lỗi rất thú vị khi 1 project sử dụng 2 công nghệ khác nhau cho persistent layer là Spring JPA và Spring JDBC." />
<meta property="og:description" content="Gần đây, tôi gặp 1 trường hợp lỗi rất thú vị khi 1 project sử dụng 2 công nghệ khác nhau cho persistent layer là Spring JPA và Spring JDBC." />
<link rel="canonical" href="/technical/92-mixing-spring-jpa-sping-jdbc-transaction-error" />
<meta property="og:url" content="/technical/92-mixing-spring-jpa-sping-jdbc-transaction-error" />
<meta property="og:site_name" content="Minh Nhật’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-03-28T00:02:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Mixing Spring JPA and Spring JDBC error: Row was updated or deleted by another transaction (or unsaved-value mapping was incorrect)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-03-28T00:02:00+00:00","datePublished":"2025-03-28T00:02:00+00:00","description":"Gần đây, tôi gặp 1 trường hợp lỗi rất thú vị khi 1 project sử dụng 2 công nghệ khác nhau cho persistent layer là Spring JPA và Spring JDBC.","headline":"Mixing Spring JPA and Spring JDBC error: Row was updated or deleted by another transaction (or unsaved-value mapping was incorrect)","mainEntityOfPage":{"@type":"WebPage","@id":"/technical/92-mixing-spring-jpa-sping-jdbc-transaction-error"},"url":"/technical/92-mixing-spring-jpa-sping-jdbc-transaction-error"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Minh Nhật&apos;s blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Minh Nhật&#39;s blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <!-- <div class="trigger"><a class="page-link" href="/404.html"></a><a class="page-link" href="/about/">Về tôi</a><a class="page-link" href="/art">art</a><a class="page-link" href="/finance">Finance</a><a class="page-link" href="/"></a><a class="page-link" href="/assets/main.css"></a><a class="page-link" href="/opinion">opinion</a><a class="page-link" href="/philosophy">Philosophy</a><a class="page-link" href="/technical">technical</a><a class="page-link" href="/art">art</a><a class="page-link" href="/art/">art</a><a class="page-link" href="/finance">Finance</a><a class="page-link" href="/finance/">Finance</a><a class="page-link" href="/"></a><a class="page-link" href="/"></a><a class="page-link" href="/page1/"></a><a class="page-link" href="/page2/"></a><a class="page-link" href="/page3/"></a><a class="page-link" href="/page4/"></a><a class="page-link" href="/opinion">opinion</a><a class="page-link" href="/opinion/">opinion</a><a class="page-link" href="/philosophy">Philosophy</a><a class="page-link" href="/philosophy/">Philosophy</a><a class="page-link" href="/technical">technical</a><a class="page-link" href="/technical/">technical</a><a class="page-link" href="/feed.xml"></a></div> -->
        <div class="trigger">
          <a class="page-link" href="/philosophy">Triết học</a>
          <a class="page-link" href="/art">Văn, thơ, nhạc</a>
          <a class="page-link" href="/opinion">Góc nhìn cá nhân</a>
          <a class="page-link" href="/technical">IT</a>
          <a class="page-link" href="/finance">Finance</a>
          <a class="page-link" href="/about">Về tôi</a>
        </div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">92. Mixing Spring JPA and Spring JDBC error: Row was updated or deleted by another transaction (or unsaved-value mapping was incorrect)</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2025-03-28T00:02:00+00:00" itemprop="datePublished">Mar 28, 2025
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Gần đây, tôi gặp 1 trường hợp lỗi rất thú vị khi 1 project sử dụng 2 công nghệ khác nhau cho persistent layer là Spring JPA và Spring JDBC.</p>

<p>Về tổng quan, Spring JDBC sẽ handle ở low level, sử dụng trực tiếp JDBC driver nhưng sẽ được viết lại các method để tránh boilerplate code. Spring JPA là 1 đặc tả ORM của Spring, và mặc định sử dụng Hibernate ORM. Với Spring JPA, Hibernate sẽ quyết định khi nào câu lệnh được gửi tới database. Do đó, khi gọi JPA.save(), ta sẽ không biết khi nào câu lệnh SQL insert/update sẽ được gửi tới database.</p>

<h2 id="tình-huống">Tình huống</h2>
<p>Tình huống tôi gặp, khái quát như sau. Giả sử có 1 danh sách list<Student>, gồm student A, B, và C. Và các học sinh này đã có tồn tại trong database</Student></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">jpa</span><span class="o">.</span><span class="na">saveAll</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>
<span class="n">jdbc</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">học</span> <span class="n">sinh</span> <span class="no">C</span><span class="o">)</span>
</code></pre></div></div>
<p>Sau khi kết thúc hàm, tới lúc commit transaction, chương trình báo lỗi: <span style="background:yellow"><em>Row was updated or deleted by another transaction (or unsaved-value mapping was incorrect)</em> </span></p>

<p>Tôi sẽ liệt kê các giả định đã đặt ra và cách kiểm chứng chúng.</p>

<h2 id="giả-định-1-spring-jpa-và-spring-jdbc-không-cùng-share-chung-1-transaction">Giả định 1: Spring JPA và Spring JDBC không cùng share chung 1 transaction</h2>

<p>Giả định này dựa trên error message: “Row was updated or deleted by another transaction”.</p>

<p>Tuy nhiên, sau khi checking DataSourceConfig, và nội bộ Spring JDBC code, có thể kết luận rằng, Spring JPA và Spring JDBC trong trường hợp tôi gặp phải, cùng sử dụng 1 active connection và cùng 1 transaction (xem thêm hàm <code class="language-plaintext highlighter-rouge">org.springframework.jdbc.datasource.DataSourceUtils.getConnection()</code>)</p>

<p>Để kiểm tra lại, có thể kiểm tra bảng <code class="language-plaintext highlighter-rouge">SELECT * FROM pg_stat_activity</code> của postgres, có thể thấy, khi thực hiện câu lệnh jpa và jdbc, chúng đều sử dụng chung 1 connection.</p>

<h3 id="giả-định-2-mixing-between-jpa-and-jdbc">Giả định 2: Mixing between JPA and JDBC.</h3>

<p>Sau khi hỏi Copilot, nghiêng về giả định việc sử dụng chung giữa JPA và JDBC. Để chứng thực, tôi chỉnh application.properties by, cho in các câu lệnh SQL mà Hibernate sẽ thực thi.</p>

<p>Sau khi kiểm tra log, phát hiện thứ tự thực hiện câu lệnh là:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="p">....</span>  <span class="c1">-- from JPA </span>
<span class="k">delete</span> <span class="n">A</span> <span class="c1">-- from JDBC </span>
<span class="k">Update</span> <span class="n">A</span> <span class="c1">-- from JPA </span>
</code></pre></div></div>

<p>Từ thứ tự thực hiện này, có thể nghiêng về lỗi : <em>unsaved-value mapping was incorrect</em></p>

<p>Để khắc việc việc này, ta có thể thêm hàm jpa.flush(). Gặp hàm này, hibernate sẽ ngay lập tức gửi câu SQL tới database, như thế, ta có thể đảm bảo câu lệnh sql được thực hiện theo mong muốn của ta. Khi đó, thứ tự sql sẽ là:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">jpa</span><span class="o">.</span><span class="na">saveAll</span><span class="o">(</span><span class="n">list</span><span class="o">)</span>
<span class="n">jpa</span><span class="o">.</span><span class="na">flush</span><span class="o">()</span>
<span class="n">jdbc</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="no">A</span><span class="o">)</span>
</code></pre></div></div>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="p">....</span>  <span class="c1">-- from JPA </span>
<span class="k">Update</span> <span class="n">A</span> <span class="c1">-- from JPA </span>
<span class="k">delete</span> <span class="n">A</span> <span class="c1">-- from JDBC </span>
</code></pre></div></div>

<p>Với việc thêm jpa.flush(), đã fix được lỗi trên.</p>

<h3 id="kết-luận">Kết luận</h3>
<p>Ta không nên kết hợp giữa 2 công nghệ khác nhau khi chúng cùng 1 mục đích, vì có thể tạo nên những lỗi “kỳ lạ”.</p>

<p>Mặc đù ORM rất tiện cho nhiều trường hợp nhưng mình không phải là fan của ORM framework =))))</p>


  </div><a class="u-url" href="/technical/92-mixing-spring-jpa-sping-jdbc-transaction-error" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Contact</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Minh Nhật&#39;s blog</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"></ul>
</div>

      <div class="footer-col footer-col-3">
        <p></p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
