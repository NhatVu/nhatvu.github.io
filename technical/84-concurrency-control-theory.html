<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Concurrency control theory | Minh Nhật’s blog</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Concurrency control theory" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="1. Transaction 2. Concurrency Control 2.1. Unrepeatable Reads 2.2. Dirty Reads 2.3. Lost Updates 2.4. Phantom Read 3. Exclusive lock và Shared lock 3.1. Exclusive lock (Khoá độc quyền) 3.2. Shared lock 4. References" />
<meta property="og:description" content="1. Transaction 2. Concurrency Control 2.1. Unrepeatable Reads 2.2. Dirty Reads 2.3. Lost Updates 2.4. Phantom Read 3. Exclusive lock và Shared lock 3.1. Exclusive lock (Khoá độc quyền) 3.2. Shared lock 4. References" />
<link rel="canonical" href="/technical/84-concurrency-control-theory" />
<meta property="og:url" content="/technical/84-concurrency-control-theory" />
<meta property="og:site_name" content="Minh Nhật’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-01-11T00:02:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Concurrency control theory" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-01-11T00:02:00+00:00","datePublished":"2025-01-11T00:02:00+00:00","description":"1. Transaction 2. Concurrency Control 2.1. Unrepeatable Reads 2.2. Dirty Reads 2.3. Lost Updates 2.4. Phantom Read 3. Exclusive lock và Shared lock 3.1. Exclusive lock (Khoá độc quyền) 3.2. Shared lock 4. References","headline":"Concurrency control theory","mainEntityOfPage":{"@type":"WebPage","@id":"/technical/84-concurrency-control-theory"},"url":"/technical/84-concurrency-control-theory"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Minh Nhật&apos;s blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Minh Nhật&#39;s blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <!-- <div class="trigger"><a class="page-link" href="/404.html"></a><a class="page-link" href="/about/">Về tôi</a><a class="page-link" href="/art">art</a><a class="page-link" href="/finance">Finance</a><a class="page-link" href="/"></a><a class="page-link" href="/assets/main.css"></a><a class="page-link" href="/opinion">opinion</a><a class="page-link" href="/philosophy">Philosophy</a><a class="page-link" href="/technical">technical</a><a class="page-link" href="/art">art</a><a class="page-link" href="/art/">art</a><a class="page-link" href="/finance">Finance</a><a class="page-link" href="/finance/">Finance</a><a class="page-link" href="/"></a><a class="page-link" href="/"></a><a class="page-link" href="/page1/"></a><a class="page-link" href="/page2/"></a><a class="page-link" href="/page3/"></a><a class="page-link" href="/page4/"></a><a class="page-link" href="/opinion">opinion</a><a class="page-link" href="/opinion/">opinion</a><a class="page-link" href="/philosophy">Philosophy</a><a class="page-link" href="/philosophy/">Philosophy</a><a class="page-link" href="/technical">technical</a><a class="page-link" href="/technical/">technical</a><a class="page-link" href="/feed.xml"></a></div> -->
        <div class="trigger">
          <a class="page-link" href="/philosophy">Triết học</a>
          <a class="page-link" href="/art">Văn, thơ, nhạc</a>
          <a class="page-link" href="/opinion">Góc nhìn cá nhân</a>
          <a class="page-link" href="/technical">IT</a>
          <a class="page-link" href="/finance">Finance</a>
          <a class="page-link" href="/about">Về tôi</a>
        </div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">84.  Concurrency control theory</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2025-01-11T00:02:00+00:00" itemprop="datePublished">Jan 11, 2025
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul>
  <li><a href="#1-transaction">1. Transaction</a></li>
  <li><a href="#2-concurrency-control">2. Concurrency Control</a>
    <ul>
      <li><a href="#21-unrepeatable-reads">2.1. Unrepeatable Reads</a></li>
      <li><a href="#22-dirty-reads">2.2. Dirty Reads</a></li>
      <li><a href="#23-lost-updates">2.3. Lost Updates</a></li>
      <li><a href="#24-phantom-read">2.4. Phantom Read</a></li>
    </ul>
  </li>
  <li><a href="#3-exclusive-lock-và-shared-lock">3. Exclusive lock và Shared lock</a>
    <ul>
      <li><a href="#31-exclusive-lock-khoá-độc-quyền">3.1. Exclusive lock (Khoá độc quyền)</a></li>
      <li><a href="#32-shared-lock">3.2. Shared lock</a></li>
    </ul>
  </li>
  <li><a href="#4-references">4. References</a></li>
</ul>

<p>Khi sử dụng database, câu hỏi đặt ra nếu nhiều user read/write cùng 1 tài nguyên tại cùng 1 thời điểm, database sẽ xử lý như thế nào?</p>

<p>Để hiểu rõ hơn cách database xử lý, trước hết ta cần hiểu tổng quan các khái niệm về Concurrency control theroy. Bài này tổng hợp từ 1 bài giảng của trường CMU - Introduction to database [1]</p>

<p>Bài viết có sử dụng ChatGPT.</p>

<h3 id="1-transaction">1. Transaction</h3>
<p>Transaction (giao dịch) là một tập hợp một hoặc nhiều các thao tác (operations: Read or Write) được thực thi như một đơn vị công việc duy nhất. Các thao tác trong một transaction phải tuân thủ nguyên tắc ACID</p>

<ul>
  <li>
    <p>A - Atomicity (Tính nguyên tử):</p>

    <ul>
      <li>Toàn bộ các thao tác trong một transaction phải được thực hiện toàn bộ hoặc không thực hiện gì cả.</li>
      <li>Nếu có lỗi xảy ra giữa chừng, toàn bộ các thay đổi sẽ bị hủy (rollback).</li>
    </ul>
  </li>
  <li>C - Consistency (Tính nhất quán):
    <ul>
      <li>Transaction phải đảm bảo dữ liệu luôn ở trạng thái hợp lệ, không vi phạm các ràng buộc (Integrity constrains như foreign key, unique, …) hoặc quy tắc kinh doanh.</li>
    </ul>
  </li>
  <li>I - Isolation (Tính độc lập):
    <ul>
      <li>Các transaction đang chạy đồng thời không được gây ảnh hưởng lẫn nhau.</li>
    </ul>
  </li>
  <li>D - Durability (Tính bền vững):
    <ul>
      <li>Sau khi một transaction hoàn tất (commit), các thay đổi phải được lưu vĩnh viễn, ngay cả khi hệ thống gặp sự cố. Database có thể sử dụng WAL để đảm bảo durability</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/images/2025/84_aicd_overview.png" alt="alt text" /></p>

<h3 id="2-concurrency-control">2. Concurrency Control</h3>
<p>Concurrency control protocol là cách mà database quyết định interleaving (xen kẽ) operations từ nhiều transaction tại runtime.</p>

<p><img src="/assets/images/2025/84_serial_execution.png" alt="alt text" /></p>

<p>Trong ví dụ trên, cả 2 kết quả đều hợp lệ, dù giá trị A và B là khác nhau khi chạy theo thứ tự T1 -&gt; T2 và T2 -&gt; T1. Thực tế là ta không thể control thứ tự chạy của T1 và T2.</p>

<p>Có một số dạng conflict phổ biến</p>
<h4 id="21-unrepeatable-reads">2.1. Unrepeatable Reads</h4>
<p><img src="/assets/images/2025/84_unrepeatable_read.png" alt="alt text" /></p>

<p>Như định nghĩa, unrepeatable read xảy ra khi trong cùng 1 transaction, giá trị của 1 object trả về khác nhau sau mỗi lần gọi. Trong ví dụ trên, trong T1, giá trị của A là lần gọi đầu tiên là 10, ở lần gọi 2 là 19.</p>

<h4 id="22-dirty-reads">2.2. Dirty Reads</h4>
<p><img src="/assets/images/2025/84_dirty_read.png" alt="alt text" /></p>

<p>Transaction read dữ liệu được ghi bởi transaction khác, nhưng transaction đó chưa commit.</p>

<p>Ví dụ Transaction 1 cập nhật giá trị của A lên 12, chưa commit, và sau đó, transaction 2 đọc giá trị A là 12.</p>

<h4 id="23-lost-updates">2.3. Lost Updates</h4>
<p><img src="/assets/images/2025/84_lost_update.png" alt="alt text" /></p>

<p>Khi hai transaction cùng đọc và ghi vào cùng một dữ liệu, kết quả ghi của transaction này có thể ghi đè kết quả của transaction kia.</p>

<p>Trong ví dụ trên, kết quả sau cùng sẽ là A = 19, B = Alice ==&gt; không hợp lệ</p>

<p>Giá trị hợp lệ sẽ là, hoặc (A=10, B=Alice) hoặc (A=19, B=Bob)</p>

<h4 id="24-phantom-read">2.4. Phantom Read</h4>
<p>Một transaction thực hiện cùng một truy vấn hai lần và thấy số lượng kết quả khác nhau vì một transaction khác đã thêm hoặc xóa dữ liệu.</p>

<p>Ví dụ:</p>

<ul>
  <li>Transaction 1 chạy truy vấn: SELECT * FROM accounts WHERE balance &gt; 100.</li>
  <li>Transaction 2 thêm một tài khoản mới có balance = 200 và commit.</li>
  <li>Transaction 1 chạy lại truy vấn và thấy kết quả thay đổi.</li>
</ul>

<h3 id="3-exclusive-lock-và-shared-lock">3. Exclusive lock và Shared lock</h3>
<p>Exclusive lock và Shared lock là 2 khái niệm nên biết trong Concurrency Control theory</p>

<h4 id="31-exclusive-lock-khoá-độc-quyền">3.1. Exclusive lock (Khoá độc quyền)</h4>
<p>Loại khóa này đảm bảo rằng chỉ một giao dịch duy nhất có thể truy cập vào tài nguyên (như một hàng, một bảng) tại cùng một thời điểm.</p>

<p>Các giao dịch khác bị chặn cho đến khi giao dịch giữ khóa độc quyền kết thúc (COMMIT hoặc ROLLBACK).</p>

<p>Khoá Exclusive lock được sử dụng cho tác tác vụ ghi như INSERT, UPDATE, DELETE</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">-- Giao dịch 1: Cập nhật dữ liệu và giữ Exclusive Lock</span>
<span class="k">BEGIN</span><span class="p">;</span>

<span class="k">UPDATE</span> <span class="n">test_table</span> <span class="k">SET</span> <span class="n">value</span> <span class="o">=</span> <span class="s1">'150'</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="c1">-- Sau đó, trong transaction 1, row có id = 1, value = 150. Để transction tiếp tục chạy </span>

<span class="c1">-- Giao dịch 2: Cố gắng đọc hoặc ghi dữ liệu cùng dòng sẽ bị chặn.</span>
<span class="k">BEGIN</span><span class="p">;</span>

<span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">test_table</span> <span class="k">where</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="c1">-- câu lệnh trả về kết quả id = 1, value = 'Updated value'. Giá trị cũ.</span>
</code></pre></div></div>

<h4 id="32-shared-lock">3.2. Shared lock</h4>

<p>Loại khóa này cho phép nhiều transaction đọc dữ liệu cùng lúc, nhưng không cho phép transaction khác ghi dữ liệu lên tài nguyên đang bị khóa chia sẻ.</p>

<p>Tài nguyên bị khóa chia sẻ vẫn có thể bị khóa thêm bởi các giao dịch khác, miễn là chúng không yêu cầu Exclusive Lock.</p>

<p>Khi một giao dịch thực hiện các thao tác đọc có khóa (LOCK FOR SHARE), như: SELECT … FOR SHARE</p>

<p>Dùng trong các trường hợp cần đảm bảo dữ liệu không bị thay đổi trong khi đang đọc.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Giao dịch 1: Đọc dữ liệu với Shared Lock</span>
<span class="k">BEGIN</span><span class="p">;</span>

<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">test_table</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">FOR</span> <span class="k">SHARE</span><span class="p">;</span>

<span class="c1">-- Giao dịch 2: Cũng có thể đọc dữ liệu với Shared Lock.</span>
<span class="k">BEGIN</span><span class="p">;</span>

<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">test_table</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">FOR</span> <span class="k">SHARE</span><span class="p">;</span>

<span class="c1">-- Giao dịch 3: Cố gắng cập nhật hoặc xóa dữ liệu</span>
<span class="c1">-- Default behaviour: câu lệnh dưới sẽ rơi vài trạng thái WAITING. Chờ cho transaction 1 và 2 commit hoặc rollback, sau đó sẽ thực hiện. Tuy nhiên, hết wait_timeout, sẽ báo lỗi. </span>
<span class="k">BEGIN</span><span class="p">;</span>

<span class="k">UPDATE</span> <span class="n">test_table</span> <span class="k">SET</span> <span class="n">value</span> <span class="o">=</span> <span class="s1">'200'</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> 

</code></pre></div></div>

<h3 id="4-references">4. References</h3>
<ol>
  <li><a href="https://www.youtube.com/watch?v=4y656idl8ZU&amp;list=PLSE8ODhjZXjYDBpQnSymaectKjxCy6BYq&amp;index=17">#16 - Concurrency Control Theory ✸ Firebolt Database Talk (CMU Intro to Database Systems)</a></li>
</ol>

  </div><a class="u-url" href="/technical/84-concurrency-control-theory" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Contact</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Minh Nhật&#39;s blog</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"></ul>
</div>

      <div class="footer-col footer-col-3">
        <p></p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
